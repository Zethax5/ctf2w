/*

Created by: Zethax
Document created on: January 25th, 2019
Last edit made on: January 28th, 2019
Current version: v0.5

Attributes in this pack:
    - "jarate killer"
    	1) How long jarate lasts on killer
	
	When killed, the attacker will be jarated for X seconds.

*/

#pragma semicolon 1
#include <sourcemod>
#include <tf2_stocks>
#include <tf2>
#include <sdkhooks>
#include <sdktools>
#include <cw3_attributes>
#include <zethax>

#define PLUGIN_NAME "tf_custom_jarate_killer"
#define PLUGIN_AUTH "Zethax"
#define PLUGIN_DESC "A custom attribute plugin containing an attribute associated with jarate"
#define PLUGIN_VERS "v0.5"

//all the voice lines are a go
#include <voice_lines>

public Plugin:my_info = {
  
	name        = PLUGIN_NAME,
	author      = PLUGIN_AUTH,
	description = PLUGIN_DESC,
	version     = PLUGIN_VERS,
	url         = ""
};

public OnPluginStart() {
 
	HookEvent("player_death", OnPlayerDeath);
}

new bool:JarateKiller[2049];
new Float:JarateKiller_Duration[2049];

public Action:CW3_OnAddAttribute(slot, client, const String:attrib[], const String:plugin[], const String:value[], bool:whileActive)
{
	if(!StrEqual(plugin, PLUGIN_NAME))
  		return Plugin_Continue;
	
	if(StrEqual(attrib, "jarate killer"))
	{
		JarateKiller_Duration[weapon] = StringToFloat(values);
		
		JarateKiller[weapon] = true;
		return Plugin_Handled;
	}
	
	return Plugin_Continue;
}

public Action:OnPlayerDeath(Handle:event, const String:name, bool:dontBroadcast)
{
	new victim = GetClientOfUserId(GetEventInt(event, "userid"));
	new attacker = GetClientOfUserId(GetEventInt(event, "attacker"));
	
	if(attacker && victim)
	{
		new secondary = GetPlayerWeaponSlot(victim, 1);
		if(JarateKiller[secondary])
		{
			TF2_AddCondition(attacker, TFCond_Jarate, JarateKiller_Duration[secondary], victim);
		}
	}
}

public OnEntityDestroyed(ent)
{
	if(ent < 0 || ent > 2048)
		return;
	
	JarateKiller[ent] = false;
	JarateKiller_Duration[ent] = 0.0;
}
