/*

Created by: Zethax
Document created on: January 25th, 2019
Last edit made on: January 28th, 2019
Current version: v1.0

Attributes in this pack:
    - "jarate killer"
    	1) How long jarate lasts on killer
	
	When killed, the attacker will be jarated for X seconds.

*/

#pragma semicolon 1
#include <sourcemod>
#include <tf2_stocks>
#include <tf2>
#include <sdkhooks>
#include <sdktools>
#include <cw3_attributes>
#include <zethax>

#define PLUGIN_NAME "tf_custom_jarate_killer"
#define PLUGIN_AUTH "Zethax"
#define PLUGIN_DESC "A custom attribute plugin containing an attribute associated with jarate"
#define PLUGIN_VERS "v1.0"

//all the voice lines are a go
#include <sniper_domination_voice_lines>

new String:ScoutDominations[7] = {"SNIPER_DOMINATION_SCOUT01", "SNIPER_DOMINATION_SCOUT02", "SNIPER_DOMINATION_SCOUT03", 
				"SNIPER_DOMINATION_SCOUT04", "SNIPER_DOMINATION_SCOUT05", "SNIPER_DOMINATION_SCOUT06", 
				"SNIPER_DOMINATION_SCOUT07"};
new String:SoldierDominations[7] = {"SNIPER_DOMINATION_SOLDIER01", "SNIPER_DOMINATION_SOLDIER02", "SNIPER_DOMINATION_SOLDIER03", 
				"SNIPER_DOMINATION_SOLDIER04", "SNIPER_DOMINATION_SOLDIER05", "SNIPER_DOMINATION_SOLDIER06", 
				"SNIPER_DOMINATION_SOLDIER07"};
new String:PyroDominations[7] = {"SNIPER_DOMINATION_PYRO01", "SNIPER_DOMINATION_PYRO02", "SNIPER_DOMINATION_PYRO03", 
				"SNIPER_DOMINATION_PYRO04", "SNIPER_DOMINATION_PYRO05", "SNIPER_DOMINATION_PYRO06", 
				"SNIPER_DOMINATION_PYRO07"};
new String:DemoDominations[7] = {"SNIPER_DOMINATION_DEMO01", "SNIPER_DOMINATION_DEMO02", "SNIPER_DOMINATION_DEMO03", 
				"SNIPER_DOMINATION_DEMO04", "SNIPER_DOMINATION_DEMO05", "SNIPER_DOMINATION_DEMO06", 
				"SNIPER_DOMINATION_DEMO07"};
new String:HeavyDominations[7] = {"SNIPER_DOMINATION_HEAVY01", "SNIPER_DOMINATION_HEAVY02", "SNIPER_DOMINATION_HEAVY03", 
				"SNIPER_DOMINATION_HEAVY04", "SNIPER_DOMINATION_HEAVY05", "SNIPER_DOMINATION_HEAVY06", 
				"SNIPER_DOMINATION_HEAVY07"};
new String:EngiDominations[7] = {"SNIPER_DOMINATION_ENGI01", "SNIPER_DOMINATION_ENGI02", "SNIPER_DOMINATION_ENGI03", 
				"SNIPER_DOMINATION_ENGI04", "SNIPER_DOMINATION_ENGI05", "SNIPER_DOMINATION_ENGI06", 
				"SNIPER_DOMINATION_ENGI07"};
new String:MedicDominations[7] = {"SNIPER_DOMINATION_MEDIC01", "SNIPER_DOMINATION_MEDIC02", "SNIPER_DOMINATION_MEDIC03", 
				"SNIPER_DOMINATION_MEDIC04", "SNIPER_DOMINATION_MEDIC05", "SNIPER_DOMINATION_MEDIC06", 
				"SNIPER_DOMINATION_MEDIC07"};
new String:SniperDominations[7] = {"SNIPER_DOMINATION_SNIPER01", "SNIPER_DOMINATION_SNIPER02", "SNIPER_DOMINATION_SNIPER03", 
				"SNIPER_DOMINATION_SNIPER04", "SNIPER_DOMINATION_SNIPER05", "SNIPER_DOMINATION_SNIPER06", 
				"SNIPER_DOMINATION_SNIPER07"};
new String:SpyDominations[7] = {"SNIPER_DOMINATION_SPY01", "SNIPER_DOMINATION_SPY02", "SNIPER_DOMINATION_SPY03", 
				"SNIPER_DOMINATION_SPY04", "SNIPER_DOMINATION_SPY05", "SNIPER_DOMINATION_SPY06", 
				"SNIPER_DOMINATION_SPY07"};

public Plugin:my_info = {
  
	name        = PLUGIN_NAME,
	author      = PLUGIN_AUTH,
	description = PLUGIN_DESC,
	version     = PLUGIN_VERS,
	url         = ""
};

public OnPluginStart() {
 
	HookEvent("player_death", OnPlayerDeath);
}

public OnMapStart() {

	for(new i = 0; i < 7; i++)
	{
		PrecacheSound(ScoutDominations[i], true);
		PrecacheSound(SoldierDominations[i], true);
		PrecacheSound(PyroDominations[i], true);
		PrecacheSound(DemoDominations[i], true);
		PrecacheSound(HeavyDominations[i], true);
		PrecacheSound(EngineerDominations[i], true);
		PrecacheSound(MedicDominations[i], true);
		PrecacheSound(SniperDominations[i], true);
		PrecacheSound(SpyDominations[i], true);
	}
}

new bool:JarateKiller[2049];
new Float:JarateKiller_Duration[2049];

public Action:CW3_OnAddAttribute(slot, client, const String:attrib[], const String:plugin[], const String:value[], bool:whileActive)
{
	if(!StrEqual(plugin, PLUGIN_NAME))
  		return Plugin_Continue;
	
	if(StrEqual(attrib, "jarate killer"))
	{
		JarateKiller_Duration[weapon] = StringToFloat(values);
		
		JarateKiller[weapon] = true;
		return Plugin_Handled;
	}
	
	return Plugin_Continue;
}

public Action:OnPlayerDeath(Handle:event, const String:name, bool:dontBroadcast)
{
	new victim = GetClientOfUserId(GetEventInt(event, "userid"));
	new attacker = GetClientOfUserId(GetEventInt(event, "attacker"));
	
	if(attacker && victim)
	{
		new secondary = GetPlayerWeaponSlot(victim, 1);
		if(JarateKiller[secondary])
		{
			TF2_AddCondition(attacker, TFCond_Jarate, JarateKiller_Duration[secondary], victim);
			new class = TF2_GetPlayerClass(attacker);
			new voiceline = GetRandomInt(0, 6);
			if(class == TFClass_Scout)
				EmitSoundToClient(attacker, ScoutDominations[voiceline]);
			else if(class == TFClass_Soldier)
				EmitSoundToClient(attacker, SoldierDominations[voiceline]);
			else if(class == TFClass_Pyro)
				EmitSoundToClient(attacker, PyroDominations[voiceline]);
			else if(class == TFClass_Demoman)
				EmitSoundToClient(attacker, DemoDominations[voiceline]);
			else if(class == TFClass_Heavy)
				EmitSoundToClient(attacker, HeavyDominations[voiceline]);
			else if(class == TFClass_Engineer)
				EmitSoundToClient(attacker, EngineerDominations[voiceline]);
			else if(class == TFClass_Medic)
				EmitSoundToClient(attacker, MedicDominations[voiceline]);
			else if(class == TFClass_Sniper)
				EmitSoundToClient(attacker, SniperDominations[voiceline]);
			else if(class == TFClass_Spy)
				EmitSoundToClient(attacker, SpyDominations[voiceline]);
		}
	}
}

public OnEntityDestroyed(ent)
{
	if(ent < 0 || ent > 2048)
		return;
	
	JarateKiller[ent] = false;
	JarateKiller_Duration[ent] = 0.0;
}
